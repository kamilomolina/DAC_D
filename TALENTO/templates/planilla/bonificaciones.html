{% extends 'menu_nomina.html' %}
{% load static %}

{% block title %}
{% if parametro == 'new' %}
CREAR PLANILLA
{% else %}
{{ id_empleado }} - TIPOS BONIFICACIONES
{% endif %}
{% endblock %}

{% block body %}


<body>
    <div class="crear-container card  p-2 ">
        <div class="row ">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body" style="background-color: #f4f6f9;">
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
                            <h4 class="text-primary">
                                Tipo Bonificación de planilla
                            </h4>
                            <button type="button"
                                class="btn btn-add-adicional animate__animated animate__pulse animate__slow animate__infinite"
                                style="background-color: #f5c542; color: #ffffff;" data-bs-toggle="modal"
                                data-bs-target="#modalCrearBonificaciones">
                                <i class="material-icons">add</i>
                            </button>

                        </div>
                        <div class="table-responsive">
                            <table id="tipos-bonificaciones-empleados"
                                class="table table-striped table-bordered table-top-border" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Automatización</th>
                                        <th>Forma</th>
                                        <th>Fecha Creado</th>
                                        <th>Creado Por</th>
                                        <th>Fecha Modificado</th>
                                        <th>Modificado Por</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic data goes here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {% include 'complementos/planilla/modal_tipo_bonificacion.html' %}
    {% include 'complementos/planilla/modal_crear_bonificaciones.html' %}
</body>

{% endblock %}
{% block scripts %}
<script>

    $(document).ready(function () {
        var toastMixin = Swal.mixin({
            toast: true,
            icon: 'success',
            title: 'General Title',
            animation: false,
            position: 'top-right',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        });

        // Inicializar Chosen en todos los select con clase .chosen-select
        $(".chosen-select").chosen({
            width: "100%"
        });


        $('.close-nueva-bonificacion').on('click', function () {
            $('#modalCrearBonificacionTipo').modal('hide');
            $('#modalCrearBonificaciones').modal('show');
        });


        // Cerrar y limpiar el modal al hacer clic en el botón
        $('.close-tipo-deduccion').on('click', function () {
            $('#modalCrearDeducciones').modal('hide');
            document.getElementById('formCrearTipoDeduccion').reset();

            // Restablecer select2
            $('#id-categoria').val('').trigger('chosen:updated');
            $('#tipo-deduccion').val('').trigger('chosen:updated');
            $('#automatizacion-deduccion').val('').trigger('chosen:updated');
        });



        // Cerrar y limpiar el modal al hacer clic en el botón
        $('.close-tipo-bonificaciones').on('click', function () {
            $('#formCrearTipoBonificaciones').modal('hide');
            document.getElementById('formCrearTipoBonificaciones').reset();

            // Restablecer select2
            $('#bonificacion-nombre').val('').trigger('chosen:updated');
            $('#automatizacion-bonificacion').val('').trigger('chosen:updated');
            // Cambiar el título del modal a 'Editar Tipo de Bonificación'
            $('#exampleModalLabelBonificacion').text('Crear tipo de Bonificaciones');
        });

        $('#bonificacion-nombre').on('change', function () {
            if ($(this).val() === "crear") {
                // Abre un modal o redirige al formulario de creación de bonificación
                $('#modalCrearBonificacionTipo').modal('show');  // Ejemplo de abrir un modal
                $('#modalCrearBonificaciones').modal('hide');  // Ejemplo de abrir un modal
                this.value = '';
            }
        });
        function cargarBonificaciones() {
            $.ajax({
                url: "{% url 'obtener_bonificaciones' %}",  // Asegúrate de que esta URL sea correcta
                type: 'GET',
                success: function (data) {
                    let bonificacionesSelect = $('#bonificacion-nombre');  // ID del select de bonificaciones
                    bonificacionesSelect.empty();  // Limpiar el select
                    bonificacionesSelect.append('<option value="" disabled selected>Seleccione una bonificación</option>'); // Placeholder
                    bonificacionesSelect.append('<option value="crear">Crear bonificación</option>'); // Opción para crear bonificación

                    if (data.bonificaciones) {
                        // Agregar las opciones de bonificaciones al select
                        data.bonificaciones.forEach(function (bonificacion) {
                            bonificacionesSelect.append(`<option value="${bonificacion.id}">${bonificacion.descripcion}</option>`);
                        });

                        // Actualizar Chosen para reflejar los nuevos cambios
                        bonificacionesSelect.trigger('chosen:updated');
                        // Ajustar el contenedor de Chosen después de la actualización
                        $('.chosen-container').css({
                            height: '38px', // Ajusta la altura al contenedor de Chosen
                        });
                        $('.chosen-container .chosen-single').css({
                            height: '38px', 
                            'line-height': '38px',
                        });
                    } else {
                        console.error('No se encontraron bonificaciones.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar las bonificaciones:', error);
                }
            });
        }

        $('#formCrearBonificacionTipo').on('submit', function (event) {
            event.preventDefault();

            // Obtener los valores del formulario
            const descripcionBonificacion = $('#descripcion-bonificacion').val().trim();
            const creadoPor = '{{ userName }}'; // Reemplaza con el valor dinámico del usuario actual
            const descripcionBonificacionMayus = descripcionBonificacion.toUpperCase();

            // Lista de campos a validar
            let campos = [
                {
                    campo: '#descripcion-bonificacion',
                    valor: descripcionBonificacion,
                    mensaje: 'El campo "Nombre de la Bonificación" es obligatorio.',
                },
            ];

            let campoInvalido = null;

            // Eliminar mensajes de error previos
            $('.invalid-feedback').remove();
            campos.forEach((item) => {
                const $campo = $(item.campo);
                const $parent = $campo.closest('.form-group'); // Ajustado para la clase form-group

                // Remover clases y mensajes previos
                $campo.removeClass('is-invalid');
                $parent.find('.invalid-feedback').remove();

                // Validar si el campo está vacío
                if (!item.valor || item.valor.trim() === '') {
                    $campo.addClass('is-invalid');
                    $parent.append(`<div class="invalid-feedback">${item.mensaje}</div>`); // Mostrar mensaje debajo del campo
                    if (!campoInvalido) campoInvalido = $campo;
                } else {
                    $campo.removeClass('is-invalid').addClass('is-valid');
                }
            });

            // Si hay un campo inválido, enfócalo y detén la ejecución
            if (campoInvalido) {
                campoInvalido.focus();
                return;
            }

            // Si pasa la validación, enviar la solicitud AJAX
            $.ajax({
                type: 'POST',
                url: '{% url "insertar_bonificacion_tipo" %}', // Asegúrate de que esta URL es correcta
                data: JSON.stringify({
                    descripcion_bonificacion: descripcionBonificacionMayus,
                    creado_por: creadoPor,
                }),
                contentType: 'application/json', // Especifica que se envía JSON
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Incluye el token CSRF manualmente
                },
                success: function (response) {
                    if (response.status === 'success') {
                        // Cerrar el modal de creación
                        $('#modalCrearBonificacionTipo').modal('hide');

                        // Crear una nueva opción para la bonificación con el ID devuelto
                        const newOption = new Option(
                            descripcionBonificacionMayus,
                            response.last_id
                        );

                        // Añadir la nueva opción al select #bonificacion-nombre y seleccionarla
                        $('#bonificacion-nombre').prepend(newOption);
                        $('#bonificacion-nombre')
                            .val(response.last_id)
                            .trigger('chosen:updated');

                        // Limpiar el formulario del modal
                        $('#descripcion-bonificacion').val('');

                        // Abrir el modal de bonificaciones
                        $('#modalCrearBonificaciones').modal('show');
                        $('#descripcion-bonificacion')
                            .removeClass('is-valid is-invalid') // Eliminar clases de validación
                            .next('.invalid-feedback') // Eliminar cualquier mensaje de error
                            .remove();
                        toastMixin.fire({
                            title: 'Tipo de bonificación creada exitosamente.',
                            icon: 'success'
                        });

                    } else {
                        // Mostrar el mensaje de error específico del servidor
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.error,
                            confirmButtonText: 'OK',
                        });
                        console.error('Error en la respuesta del servidor:', response.error);
                    }
                },
                error: function (response) {
                    const errorMessage =
                        response.responseJSON && response.responseJSON.error
                            ? response.responseJSON.error
                            : 'No se pudo crear la bonificación. Por favor, intente nuevamente.';
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMessage,
                        confirmButtonText: 'OK',
                    });
                    console.error('Error al crear la bonificación', response);
                },
            });
        });


        // Eliminar el color rojo y el mensaje de error cuando el usuario comienza a escribir o cambiar una selección
        $('#formCrearBonificacionTipo').on('input change', '.is-invalid', function () {
            const $campo = $(this); // Campo que genera el evento
            const $parent = $campo.closest('.form-group'); // Contenedor padre con la clase form-group

            // Remover la clase de error y el mensaje de error
            $campo.removeClass('is-invalid').addClass('is-valid');
            $parent.find('.invalid-feedback').remove();
        });


        $('.close1').on('click', function () {
            $('#tipoBonificacionModal').modal('hide');
        });

        let tableBonificaciones;

        function initializeTableBonificaciones() {
            // Destruir la tabla existente si ya está inicializada
            if ($.fn.DataTable.isDataTable('#tipos-bonificaciones-empleados')) {
                $('#tipos-bonificaciones-empleados').DataTable().clear().destroy();
            }

            // Inicializar la tabla de tipos de bonificaciones
            tableBonificaciones = $('#tipos-bonificaciones-empleados').DataTable({
                autoWidth: false,
                scrollX: true,
                scrollY: '300px',
                scrollCollapse: true,
                pageLength: 50,
                dom: 'Bfrtip',
                language: {
                    "processing": "Procesando...",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron resultados",
                    "emptyTable": "Ningún dato disponible en esta tabla",
                    "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                ajax: {
                    url: "{% url 'mostrar_tipos_bonificaciones' %}",  // URL de la vista que proporciona datos
                    type: "GET",
                    dataSrc: function (json) {
                        console.log('Datos recibidos de la solicitud AJAX:', json);

                        if (json.bonificaciones && Array.isArray(json.bonificaciones)) {
                            return json.bonificaciones;
                        } else {
                            console.error("Error: La clave 'bonificaciones' no está presente o no es un array.");
                            return [];
                        }
                    }
                },
                colReorder: {
                    realtime: false,
                },
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i>',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success',
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i>',
                        titleAttr: 'Exportar a PDF',
                        className: 'btn btn-danger',
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i>',
                        titleAttr: 'Imprimir',
                        className: 'btn btn-primary',
                        orientation: 'landscape'
                    }
                ],
                columns: [
                    { "data": "id_bonificacion", "title": "#" },
                    { "data": "nombre_bonificacion", "title": "Nombre" },  // Nombre de la bonificación
                    { "data": "descripcion_tipo", "title": "Descripción" },
                    {
                        "data": "automatizacion",
                        "render": function (data, type, row) {
                            return data ? 'Sí' : 'No';
                        },
                        "title": "Automatización"
                    },
                    { "data": "forma", "title": "Forma" },
                    {
                        "data": "fecha_creacion", "title": "Fecha Creado",
                        className: 'text-wrap'
                    },
                    { "data": "creado_por", "title": "Creado Por" },
                    {
                        "data": "fecha_modificacion", "title": "Fecha Modificado",
                        className: 'text-wrap'
                    },
                    { "data": "modificado_por", "title": "Modificado Por" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `
                                <div class="btn-group">
                                <button class="btn btn-warning btn-sm btn-edit-tip-boni" data-id="${row.id_bonificacion}">
                                    <i class="fas fa-edit"></i>
                                </button> 
                                <button class="btn btn-danger btn-sm btn-delete-tip-boni" data-id="${row.id_bonificacion}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                </div>
                            
                                `;
                        },
                        "orderable": false,
                        "width": '10%',
                        "title": "Acciones"
                    }
                ],
                order: [[0, "asc"]],
                fixedColumns: {
                    left: 0,
                    right: 2
                },
            });
        }

        $(document).on('click', '.btn-edit-tip-boni', function (e) {
            e.preventDefault();  // Evita la recarga de la página

            var bonificacionRow = $(this).closest('tr');  // Obtiene la fila más cercana
            var rowData = tableBonificaciones.row(bonificacionRow).data();  // Obtiene los datos de la fila desde DataTables
            console.log("Datos de la fila seleccionada:", rowData);

            // Cargar los datos en el modal usando los valores de rowData
            $('#id-bonificacion').val(rowData.id_bonificacion);  // ID de la bonificación
            $('#bonificacion-nombre').val(rowData.id_categoria).trigger('chosen:updated');  // Categoría de bonificación
            $('#descripcion-bonificaciones').val(rowData.descripcion_tipo);  // Nombre de la bonificación
            $('#forma-bonificacion').val(rowData.forma);  // Forma de bonificación
            $('#automatizacion-bonificacion').val(rowData.automatizacion).trigger('chosen:updated'); // Estado de automatización

            // Cambiar el título del modal a 'Editar Tipo de Bonificación'
            $('#exampleModalLabelBonificacion').text('Editar tipo de Bonificación');

            // Cambiar el texto del botón de guardar a 'Actualizar'
            $('#guardar-editar-bonificaciones').text('Actualizar');

            // Abrir el modal
            $('#modalCrearBonificaciones').modal('show');
        });

        $(document).on('click', '.btn-delete-tip-boni', function () {
            var idBonificacion = $(this).data('id');
            var csrfToken = '{{ csrf_token }}';  // Obtiene el token CSRF desde el contexto de la plantilla

            // Confirmación antes de eliminar
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción cambiará el estado de la bonificación a 'Eliminada'.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28A745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Llamada AJAX para eliminar la bonificación
                    $.ajax({
                        url: "{% url 'eliminar_tipo_bonificacion' %}",  // Ajusta la URL según tu ruta en Django
                        type: 'POST',
                        data: {
                            id_bonificacion: idBonificacion,
                            modificado_por: '{{ userName }}',  // Ajusta con el usuario actual
                            csrfmiddlewaretoken: csrfToken
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Eliminado',
                                    text: 'La bonificación se ha eliminado correctamente.',
                                    confirmButtonText: 'OK'
                                });
                                // Recargar la tabla de bonificaciones
                                tableBonificaciones.ajax.reload();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message || 'Hubo un problema al eliminar la bonificación.',
                                    confirmButtonText: 'OK'
                                });
                            }
                        },
                        error: function (xhr) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Hubo un problema al realizar la solicitud.',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        });

        // Llama a la función para inicializar la tabla
        $(document).ready(function () {
            initializeTableBonificaciones();
        });

        $('#formCrearTipoBonificaciones').on('submit', function (event) {
            event.preventDefault(); // Prevenir el envío tradicional del formulario.

            // Obtener los valores de los campos.
            const bonificacionNombre = $('#bonificacion-nombre').val();
            const descripcionBonificacion = $('#descripcion-bonificaciones').val().trim();
            const formaBonificacion = $('#forma-bonificacion').val().trim();
            const automatizacionBonificacion = $('#automatizacion-bonificacion').val();

            // Lista de campos y mensajes de validación.
            const campos = [
                {
                    campo: '#bonificacion-nombre',
                    valor: bonificacionNombre,
                    mensaje: 'Debe seleccionar una categoría.',
                },
                {
                    campo: '#forma-bonificacion',
                    valor: formaBonificacion,
                    mensaje: 'El campo "Forma" es obligatorio.',
                },
                {
                    campo: '#automatizacion-bonificacion',
                    valor: automatizacionBonificacion,
                    mensaje: 'Debe seleccionar una opción de automatización.',
                },
            ];

            let campoInvalido = null;

            // Eliminar mensajes de error previos.
            $('.invalid-feedback').remove();
            $('.is-invalid').removeClass('is-invalid');
            $('.is-valid').removeClass('is-valid');

            // Validar cada campo.
            campos.forEach((item) => {
                const $campo = $(item.campo);
                const $parent = $campo.closest('.mb-3'); // El contenedor más cercano del campo.

                if (!item.valor || item.valor.trim() === '') {
                    $campo.addClass('is-invalid');
                    $parent.append(`<div class="invalid-feedback">${item.mensaje}</div>`); // Mostrar mensaje de error.
                    if (!campoInvalido) campoInvalido = $campo;
                } else {
                    /* $campo.addClass('is-valid'); */
                }
            });

            // Si hay un campo inválido, enfócalo y detén la ejecución.
            if (campoInvalido) {
                campoInvalido.focus();
                return;
            }

            // Si pasa la validación, proceder con la solicitud AJAX.
            $.ajax({
                type: 'POST',
                url: '{% url "guardar_tipo_bonificacion" %}', // Asegúrate de que esta URL sea correcta.
                data: JSON.stringify({
                    bonificacion_nombre: bonificacionNombre,
                    descripcion_bonificacion: descripcionBonificacion,
                    forma_bonificacion: formaBonificacion,
                    automatizacion_bonificacion: automatizacionBonificacion,
                    creado_por: '{{ userName }}',
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                success: function (response) {
                    if (response.status === 'success') {
                        // Cerrar el modal y resetear el formulario.
                        // Cerrar el modal y resetear el formulario.
                        $('#modalCrearBonificaciones').modal('hide');
                        $('#formCrearTipoBonificaciones')[0].reset();
                        $('.chosen-select').val('').trigger('chosen:updated');

                        resetFormAndSelects();

                        if (typeof tableBonificaciones !== 'undefined') {
                            tableBonificaciones.ajax.reload(); // Recargar la tabla de bonificaciones
                        }
                        toastMixin.fire({
                            title: 'Tipo de bonificación guardado correctamente.',
                            icon: 'success'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.error || 'No se pudo guardar la bonificación.',
                        });
                    }
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al realizar la solicitud.',
                    });
                },
            });
        });



        $(document).on('click', '.close-tipo-bonificaciones', function () {
            // Reiniciar el formulario
            $('#formCrearTipoBonificaciones')[0].reset();

            // Remover clases de validación y mensajes de error
            $('#formCrearTipoBonificaciones .is-valid, #formCrearTipoBonificaciones .is-invalid').removeClass('is-valid is-invalid');
            $('.invalid-feedback').remove();

            // Reiniciar selects y Chosen
            $('#bonificacion-nombre').val('').trigger('chosen:updated');
            $('#automatizacion-bonificacion').val('');

            // Restablecer el título del modal y el texto del botón de guardar
            $('#exampleModalLabelBonificacion').text('Crear tipo de Bonificaciones');
            $('#guardar-editar-bonificaciones').text('Guardar');
        });

        $('#formCrearTipoBonificaciones').on('input change', '.is-invalid, .chosen-select', function () {
            const $elemento = $(this);
            const $chosenContainer = $elemento.hasClass('chosen-select') ? $elemento.next('.chosen-container') : null;

            // Remover is-invalid y agregar is-valid
            $elemento.removeClass('is-invalid').addClass('is-valid').next('.invalid-feedback').remove();

            if ($chosenContainer) {
                $chosenContainer.removeClass('is-invalid').addClass('is-valid');
                $chosenContainer.find('.invalid-feedback').remove();
            }
        });
        function resetFormAndSelects() {
            $('.is-valid').removeClass('is-valid');
            $('#formCrearTipoBonificaciones')[0].reset();  // Limpiar el formulario
            $('#bonificacion-nombre').val('').trigger('chosen:updated');  // Reiniciar select de categoría
            $('#automatizacion-bonificacion').val('').trigger('chosen:updated');  // Reiniciar select de automatización
            $('#id-bonificacion').val('');  // Limpiar el campo oculto de ID de bonificación
        }
        cargarBonificaciones();
    });
</script>
{% endblock %}