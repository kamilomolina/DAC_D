{% extends 'menu_nomina.html' %}
{% load static %}

{% block title %}
{% if parametro == 'new' %}
CREAR PLANILLA
{% else %}
{{ id_empleado }} - TIPOS ComisionES
{% endif %}
{% endblock %}

{% block body %}


<body>
    <div class="crear-container card  p-2 ">
        <div class="row ">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body" style="background-color: #f4f6f9;">
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
                            <h4 class="text-primary">
                                Tipo Comisión de planilla
                            </h4>
                            <button type="button"
                                class="btn btn-add-adicional animate__animated animate__pulse animate__slow animate__infinite"
                                style="background-color: #f5c542; color: #ffffff;" data-bs-toggle="modal"
                                data-bs-target="#modalCrearComisiones">
                                <i class="material-icons">add</i>
                            </button>

                        </div>
                        <div class="table-responsive">
                            <table id="tipos-Comisiones-empleados"
                                class="table table-striped table-bordered table-top-border" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Automatización</th>
                                        <th>Forma</th>
                                        <th>Fecha Creado</th>
                                        <th>Creado Por</th>
                                        <th>Fecha Modificado</th>
                                        <th>Modificado Por</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic data goes here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    {% include 'complementos/planilla/modal_crear_comisiones.html' %}
</body>

{% endblock %}
{% block scripts %}
<script>

    $(document).ready(function () {
        // Configurar el mixin de Toasts
        var toastMixin = Swal.mixin({
            toast: true,
            icon: 'success',
            title: 'General Title',
            animation: false,
            position: 'top-right',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        });

        // Inicializar Chosen en todos los select con clase .chosen-select
        $(".chosen-select").chosen({
            width: "100%"
        });

        $('.close-nueva-Comision').on('click', function () {
            $('#modalCrearComisionTipo').modal('hide');
            $('#modalCrearComisiones').modal('show');
        });



        // Cerrar y limpiar el modal al hacer clic en el botón
        $('.close-tipo-Comisiones').on('click', function () {
            $('#formCrearTipoComisiones').modal('hide');
            document.getElementById('formCrearTipoComisiones').reset();

            // Restablecer select2
            $('#Comision-nombre').val('').trigger('chosen:updated');
            $('#automatizacion-Comision').val('').trigger('chosen:updated');
            // Cambiar el título del modal a 'Editar Tipo de Bonificación'
            $('#exampleModalLabelComision').text('Crear tipo de Comisiones');
        });

        $('#Comision-nombre').on('change', function () {
            if ($(this).val() === "crear") {
                // Abre un modal o redirige al formulario de creación de bonificación
                $('#modalCrearComisionTipo').modal('show');  // Ejemplo de abrir un modal
                $('#modalCrearComisiones').modal('hide');  // Ejemplo de abrir un modal
                this.value = '';
            }
        });

        // Eliminar el color rojo y el mensaje de error cuando el usuario comienza a escribir o cambiar una selección
        $('#formCrearComisionTipo').on('input change', '.is-invalid', function () {
            const $campo = $(this); // Campo que genera el evento
            const $parent = $campo.closest('.form-group'); // Contenedor padre con la clase form-group

            // Remover la clase de error y el mensaje de error
            $campo.removeClass('is-invalid').addClass('is-valid');
            $parent.find('.invalid-feedback').remove();
        });

        $('.close1').on('click', function () {
            $('#tipoComisionModal').modal('hide');
        });

        let tableComisiones;

        function initializetableComisiones() {
            // Destruir la tabla existente si ya está inicializada
            if ($.fn.DataTable.isDataTable('#tipos-Comisiones-empleados')) {
                $('#tipos-Comisiones-empleados').DataTable().clear().destroy();
            }

            // Inicializar la tabla de tipos de Comisiones
            tableComisiones = $('#tipos-Comisiones-empleados').DataTable({
                autoWidth: false,
                scrollX: true,
                scrollY: '300px',
                scrollCollapse: true,
                pageLength: 50,
                dom: 'Bfrtip',
                language: {
                    "processing": "Procesando...",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron resultados",
                    "emptyTable": "Ningún dato disponible en esta tabla",
                    "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                ajax: {
                    url: "{% url 'mostrar_tipos_Comisiones' %}",  // URL de la vista que proporciona datos
                    type: "GET",
                    dataSrc: function (json) {
                        console.log('Datos recibidos de la solicitud AJAX:', json);

                        if (json.Comisiones && Array.isArray(json.Comisiones)) {
                            return json.Comisiones;
                        } else {
                            console.error("Error: La clave 'Comisiones' no está presente o no es un array.");
                            return [];
                        }
                    }
                },
                colReorder: {
                    realtime: false,
                },
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i>',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success',
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i>',
                        titleAttr: 'Exportar a PDF',
                        className: 'btn btn-danger',
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i>',
                        titleAttr: 'Imprimir',
                        className: 'btn btn-primary',
                        orientation: 'landscape'
                    }
                ],
                columns: [
                    { "data": "id_Comision", "title": "#" },
                    { "data": "nombre_Comision", "title": "Nombre" },  // Nombre de la bonificación
                    { "data": "descripcion_tipo", "title": "Descripción" },
                    {
                        "data": "automatizacion",
                        "render": function (data, type, row) {
                            return data ? 'Sí' : 'No';
                        },
                        "title": "Automatización"
                    },
                    { "data": "forma", "title": "Forma" },
                    {
                        "data": "fecha_creacion", "title": "Fecha Creado",
                        className: 'text-wrap'
                    },
                    { "data": "creado_por", "title": "Creado Por" },
                    {
                        "data": "fecha_modificacion", "title": "Fecha Modificado",
                        className: 'text-wrap'
                    },
                    { "data": "modificado_por", "title": "Modificado Por" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `
                                <div class="btn-group">
                                <button class="btn btn-warning btn-sm btn-edit-tip-Comision" data-id="${row.id_Comision}">
                                    <i class="fas fa-edit"></i>
                                </button> 
                                <button class="btn btn-danger btn-sm btn-delete-tip-Comision" data-id="${row.id_Comision}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                </div>
                            
                                `;
                        },
                        "orderable": false,
                        "width": '10%',
                        "title": "Acciones"
                    }
                ],
                order: [[0, "asc"]],
                fixedColumns: {
                    left: 0,
                    right: 2
                },
            });
        }

        $(document).on('click', '.btn-edit-tip-Comision', function (e) {
            e.preventDefault();  // Evita la recarga de la página

            var ComisionRow = $(this).closest('tr');  // Obtiene la fila más cercana
            var rowData = tableComisiones.row(ComisionRow).data();  // Obtiene los datos de la fila desde DataTables

            // Mostrar los datos de la fila seleccionada en la consola para depuración
            console.log("Datos de la fila seleccionada:", rowData);

            // Verifica si los datos de la fila se están cargando correctamente
            if (!rowData) {
                console.error("No se pudo obtener datos para la fila seleccionada.");
                return;
            }

            // Cargar los datos en el modal usando los valores de rowData
            $('#id-comision').val(rowData.id_Comision);  // ID de la comisión
            $('#descripcion-Comision').val(rowData.nombre_Comision);  // Comisión
            $('#Comision-nombre').val(rowData.descripcion_tipo);  // Descripción
            $('#forma-Comision').val(rowData.forma);  // Forma de la comisión
            $('#automatizacion-Comision').val(rowData.automatizacion).trigger('chosen:updated'); // Automatización

            // Cambiar el título del modal a 'Editar Tipo de Comisión'
            $('#exampleModalLabelComision').text('Editar tipo de Comisión');

            // Cambiar el texto del botón de guardar a 'Actualizar'
            $('#guardar-editar-Comisiones').text('Actualizar');

            // Abrir el modal
            $('#modalCrearComisiones').modal('show');
        });

        $(document).on('click', '.btn-delete-tip-Comision', function () {
            var idComision = $(this).data('id');
            var csrfToken = '{{ csrf_token }}';  // Obtiene el token CSRF desde el contexto de la plantilla

            // Confirmación antes de eliminar
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción cambiará el estado de la comisión a 'Eliminada'.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28A745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Llamada AJAX para eliminar la bonificación
                    $.ajax({
                        url: "{% url 'eliminar_tipo_Comision' %}",  // Ajusta la URL según tu ruta en Django
                        type: 'POST',
                        data: {
                            id_Comision: idComision,
                            modificado_por: '{{ userName }}',  // Ajusta con el usuario actual
                            csrfmiddlewaretoken: csrfToken
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                // Recargar la tabla de Comisiones
                                tableComisiones.ajax.reload();
                                toastMixin.fire({
                                    title: 'La comisión se ha eliminado correctamente.',
                                    icon: 'success',
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message || 'Hubo un problema al eliminar la bonificación.',
                                    confirmButtonText: 'OK'
                                });
                            }
                        },
                        error: function (xhr) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Hubo un problema al realizar la solicitud.',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        });

        // Llama a la función para inicializar la tabla
        $(document).ready(function () {
            initializetableComisiones();
        });

        $('#formCrearTipoComisiones').on('submit', function (event) {
            event.preventDefault(); // Prevenir el envío tradicional del formulario.

            // Obtener los valores de los campos.
            const idComision = $('#id-comision').val();  // Obtener el ID de la comisión
            const ComisionNombre = $('#descripcion-Comision').val().trim();
            const descripcionComision = $('#Comision-nombre').val().trim();
            const formaComision = $('#forma-Comision').val().trim();
            const automatizacionComision = $('#automatizacion-Comision').val();

            // Lista de campos y mensajes de validación.
            const campos = [
                {
                    campo: '#descripcion-Comision',
                    valor: ComisionNombre,
                    mensaje: 'El campo "Nombre de Comisión" es obligatorio.',
                },
                {
                    campo: '#forma-Comision',
                    valor: formaComision,
                    mensaje: 'El campo "Forma" es obligatorio.',
                },
                {
                    campo: '#automatizacion-Comision',
                    valor: automatizacionComision,
                    mensaje: 'Debe seleccionar una opción de automatización.',
                },
            ];

            let campoInvalido = null;

            // Eliminar mensajes de error previos.
            $('.invalid-feedback').remove();
            $('.is-invalid').removeClass('is-invalid');
            $('.is-valid').removeClass('is-valid');

            // Validar cada campo.
            campos.forEach((item) => {
                const $campo = $(item.campo);
                const $parent = $campo.closest('.mb-3'); // El contenedor más cercano del campo.

                if (!item.valor || item.valor.trim() === '') {
                    $campo.addClass('is-invalid');
                    $parent.append(`<div class="invalid-feedback">${item.mensaje}</div>`); // Mostrar mensaje de error.
                    if (!campoInvalido) campoInvalido = $campo;
                } else {
                    /* $campo.addClass('is-valid'); */
                }
            });

            // Si hay un campo inválido, enfócalo y detén la ejecución.
            if (campoInvalido) {
                campoInvalido.focus();
                return;
            }

            // Si pasa la validación, proceder con la solicitud AJAX.
            $.ajax({
                type: 'POST',
                url: '{% url "guardar_tipo_Comisiones" %}', // Asegúrate de que esta URL sea correcta.
                data: JSON.stringify({
                    id_comision: idComision,  // Incluye el ID de la comisión para actualizar
                    Comision_nombre: ComisionNombre,
                    descripcion_Comision: descripcionComision,
                    forma_Comision: formaComision,
                    automatizacion_Comision: automatizacionComision,
                    creado_por: '{{ userName }}',
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                success: function (response) {
                    if (response.status === 'success') {
                        // Cerrar el modal y resetear el formulario.
                        $('#modalCrearComisiones').modal('hide');
                        $('#formCrearTipoComisiones')[0].reset();
                        $('.chosen-select').val('').trigger('chosen:updated');

                        if (typeof tableComisiones !== 'undefined') {
                            tableComisiones.ajax.reload(); // Recargar la tabla de Comisiones
                        }
                        toastMixin.fire({
                            title: 'Tipo de comisión guardado correctamente.',
                            icon: 'success',
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.error || 'No se pudo guardar la comisión.',
                        });
                    }
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al realizar la solicitud.',
                    });
                },
            });
        });



        $(document).on('click', '.close-tipo-Comisiones', function () {
            // Reiniciar el formulario
            $('#formCrearTipoComisiones')[0].reset();

            // Remover clases de validación y mensajes de error
            $('#formCrearTipoComisiones .is-valid, #formCrearTipoComisiones .is-invalid').removeClass('is-valid is-invalid');
            $('.invalid-feedback').remove();

            // Reiniciar selects y Chosen
            $('#Comision-nombre').val('').trigger('chosen:updated');
            $('#automatizacion-Comision').val('');

            // Restablecer el título del modal y el texto del botón de guardar
            $('#exampleModalLabelComision').text('Crear tipo de Comisiones');
            $('#guardar-editar-Comisiones').text('Guardar');
        });

        $('#formCrearTipoComisiones').on('input change', '.is-invalid, .chosen-select', function () {
            const $elemento = $(this);
            const $chosenContainer = $elemento.hasClass('chosen-select') ? $elemento.next('.chosen-container') : null;

            // Remover is-invalid y agregar is-valid
            $elemento.removeClass('is-invalid').addClass('is-valid').next('.invalid-feedback').remove();

            if ($chosenContainer) {
                $chosenContainer.removeClass('is-invalid').addClass('is-valid');
                $chosenContainer.find('.invalid-feedback').remove();
            }
        });


        function resetFormAndSelects() {
            $('.is-valid').removeClass('is-valid');
            $('#formCrearTipoComisiones')[0].reset();  // Limpiar el formulario
            $('#Comision-nombre').val('').trigger('chosen:updated');  // Reiniciar select de categoría
            $('#automatizacion-Comision').val('').trigger('chosen:updated');  // Reiniciar select de automatización
            $('#id-Comision').val('');  // Limpiar el campo oculto de ID de bonificación
        }

    });
</script>
{% endblock %}