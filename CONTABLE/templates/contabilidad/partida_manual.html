{% extends 'componentes/menu_contable.html' %}
{% load static %}

{% block title %}
{% if partida_id == '0' or partida_id == 0 %}
NUEVA PARTIDA MANUAL
{% else %}
EDITAR PARTIDA # {{ partida_id }}
{% endif %}
{% endblock %}

<style>
    /* Contenedor Sticky */
    .sticky-footer-container {
        position: sticky;
        bottom: 0;
        z-index: 10;
        /* Asegura que esté por encima del contenido */
        background-color: white;
        /* Color de fondo para visibilidad */
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        /* Sombra opcional */
    }

    /* Asegura que la tabla no se desborde */
    .sticky-footer {
        margin: 0;
        width: 100%;
        border-collapse: collapse;
    }
</style>

{% block body %}

<div class="row align-items-center">
    <div class="col d-flex align-items-center">
        <button id="toggle-sidebar" class="hamburger btnMenu me-3" title="Mostrar/Ocultar Menu">
            <i class="fas fa-bars"></i>
        </button>
        <h3 class="page-title mb-0">
            {% if partida_id == '0' or partida_id == 0 %}
            NUEVA PARTIDA MANUAL
            {% else %}
            EDITAR PARTIDA # {{ partida_id }}
            {% endif %}
        </h3>
    </div>
</div>

<hr>

<div class="row">
    
    <div class="row mb-3">

        <div class="col-md-3">
            <div class="form-group">
                <label for="">Empresa:</label>
                <select id="empresaPartida" class="form-select form-select-sm" name="empresaPartida">
                    {% for e in empresasData %}
                    <option value="{{ e.id }}">{{ e.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="col-md-3">
            <div class="form-group">
                <label for="fechaPartida">Fecha Partida:</label>
                <input type="datetime-local" class="form-control form-control-sm" id="fechaPartida"
                    value="{{ fecha_hora_actual }}">
            </div>
        </div>

        <div class="col-md-3">
            <div class="form-group">
                <label for="tasaCambio">Tasa de Cambio:</label>
                <input type="number" class="form-control form-control-sm" id="tasaCambio" value="{{ tasaCambio }}"
                    step="0.01">
            </div>
        </div>

        <div class="col-md-3">
            <div class="form-group">
                <label for="">Tipo de Partda:</label>
                <select id="tipo_partida" class="form-select form-select-sm" name="tipo_partida">
                    <option value="012">PARTIDAS MANUALES</option>
                </select>
            </div>
        </div>

    </div>

    <div class="row mb-2">
        <div class="col-sm-12">
            <div class="form-group">
                <label for="sinopsisPartida">Sinopsis Partida:</label>
                <textarea class="form-control form-control-sm" id="sinopsisPartida"
                    placeholder="Sinopsis Partida">{{ sinopsis }}</textarea>
            </div>
        </div>
    </div>

    <hr>

    <div class="table-responsive">

        <table id="tablePartidaManual"
            class="table table-striped table-bordered mb-0 table-sm rounded-4 table-hover align-middle"
            style="width: 100%;">
            <thead class="table-gradient text-dark">
                <tr>
                    <th>Codigo</th>
                    <th>Sinopsis</th>
                    <th>Debe</th>
                    <th>Haber</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody id="tabla-datos">

                <!-- Fila inicial (inputs vacíos) -->
                <tr>
                    <td>
                        <select class="form-select form-select-sm codigo_dom" id="codigo">
                            <option value="" disabled selected>Seleccione una Cuenta</option>
                            {% for cta in cuentasData %}
                            <option value="{{cta.CodigoCuenta}}">{{ cta.CodigoCuenta }} - {{ cta.Concepto }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" id="sinopsis"
                            placeholder="Ingrese una Sinopsis">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm formattedMoneyInputs" id="debe" placeholder="0.00">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm formattedMoneyInputs" id="haber" placeholder="0.00">
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" id="agregar">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                </tr>

                {% for d in detallesPartidaData %}
                <tr>
                    <td>
                        <select class="form-select form-select-sm codigo_dom">
                            {% for cta in cuentasData %}
                            <option value="{{cta.CodigoCuenta}}" {% if d.CodigoCuenta == cta.CodigoCuenta %} selected {% endif %}>
                                {{ cta.CodigoCuenta }} - {{ cta.Concepto }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="editable sinopsis" contenteditable="true">{{ d.Sinopsis }}</td>
                    <td class="editable debe text-right" contenteditable="true">{{ d.Debe }}</td>
                    <td class="editable haber text-right" contenteditable="true">{{ d.Haber }}</td>
                    <td><button type="button" class="btn btn-sm btn-danger eliminar"><i
                                class="fas fa-trash"></i></button></td>
                </tr>
                {% endfor %}

            </tbody>

        </table>

    </div>
</div>

<br><br>

<div class="sticky-bottom bg-white border-top shadow-sm">
    <table class="table table-bordered table-striped table-sm mb-0 rounded-4 table-hover">
        <tbody>
            <tr>
                <td class="text-end fw-bold">
                    <b>Total Partida:</b>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm text-end cleanInputs formattedMoneyInputs"
                        id="totalPartida" value="{{ balance }}">
                </td>
                <td class="text-end fw-bold">
                    <b>Total DEBE:</b>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm text-end cleanInputs" id="totalDebe" readonly
                        value="0.00">
                </td>
                <td class="text-end fw-bold">
                    <b>Total HABER:</b>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm text-end cleanInputs" id="totalHaber"
                        readonly value="0.00">
                </td>
                <td class="text-end">
                    <button type="button" class="btn btn-success btn-sm" id="btnGuardar">Guardar</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>


{% endblock %}



{% block scripts %}

<script>
    $(document).ready(function () {
        var partida_id = "{{ partida_id }}";
        var empresa_id = "{{ empresa }}";
        var csrfToken = "{{ csrf_token }}";

        if (partida_id == 0) {
            var opcion = 1;

            $('#sinopsis').val('');
            $('.cleanInputs').val(0.00);

            getTasaCambioActual();
        } else {
            var opcion = 2;
        }

        $('#empresaPartida').val(empresa_id).change();

        $('.codigo_dom').select2({ width: '100%' });
        
        var toastMixin = Swal.mixin({
            toast: true,
            icon: 'success',
            title: 'General Title',
            animation: false,
            position: 'top-right',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        });

        let dollarUSLocale = Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        let intergerLocale = Intl.NumberFormat("en-US", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        /* MENU ID Y SUBMENU ID */
        $('#contabilidadMenu, #nuevaPartidaManual_submenu').addClass('active');

        $('#tablePartidaManual').DataTable({
            autoWidth: false,
            scrollX: true,
            scrollY: '350px',
            scrollCollapse: true,
            pageLength: 5,
            dom: 'tip',
            order: [], // Desactiva el ordenamiento inicial
            columnDefs: [
                { orderable: false, targets: '_all' } // Desactiva el ordenamiento para todas las columnas
            ]
        });


        $('#empresaPartida').change(function (e) {
            e.preventDefault();

            const empresa = $(this).val();

            const nuevaURL = "{% url 'conta_new_edit_partida' 0 2 %}".replace(2, empresa);

            window.location.href = nuevaURL;
        });

        $('#fechaPartida').change(function (e) { 
            e.preventDefault();
            
            getTasaCambioActual();
        });

        function getTasaCambioActual() {
            fecha_partida = $('#fechaPartida').val().trim();

            $.ajax({
                url: "{% url 'get_tasa_cambio_x_fecha' %}",
                type: 'POST',
                data: {
                    fecha_partida: fecha_partida,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function (data) {
                    if (data.save == 1) {
                        $('#tasaCambio').val(data.tasa_cambio);
                    } else {
                        $('#tasaCambio').val(0.00);
                    }
                }
            });
        }


        $('#agregar').click(function () {

            const codigoConcepto = $('#codigo').val();
            const codigo = codigoConcepto;
            const sinopsis = $('#sinopsis').val();
            const debe = parseFloat($('#debe').val().replace(/,/g, "")) || 0;
            const haber = parseFloat($('#haber').val().replace(/,/g, "")) || 0;

            if (!codigo) {
                Swal.fire("", "Seleccione un código.", "warning");
                return;
            }
            if (!sinopsis.trim()) {
                Swal.fire("", "Ingrese una sinopsis.", "warning");
                return;
            }
            if ((debe === 0 && haber === 0) || (debe > 0 && haber > 0)) {
                Swal.fire("", "Debe llenar solo uno de los campos: Debe o Haber.", "warning");
                return;
            }

            const opcionesSelect = $('#codigo').html();

            // Agregar fila
            const nuevaFila = `
                <tr>
                    <td>
                        <select class="form-select form-select-sm codigo-select">
                            ${opcionesSelect}
                        </select>
                    </td>
                    <td class="editable sinopsis" contenteditable="true">${sinopsis}</td>
                    <td class="editable debe text-right" contenteditable="true">${debe > 0.00 ? dollarUSLocale.format(debe) : 0.00}</td>
                    <td class="editable haber text-right" contenteditable="true">${haber > 0.00 ? dollarUSLocale.format(haber) : 0.00}</td>
                    <td><button type="button" class="btn btn-sm btn-danger eliminar"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            $('#tabla-datos').append(nuevaFila);

            $('#tabla-datos tr:last .codigo-select').val(codigoConcepto);
            $('.codigo-select').select2({ width: '100%' });

            // Actualizar totales
            actualizarTotales();

            // Limpiar campos
            $('#codigo').val('').change();
            $('#sinopsis').val('');
            $('#debe').val('');
            $('#haber').val('');
        });

        $('#tabla-datos').on('blur', '.editable', function () {
            actualizarTotales();
        });

        // Eliminar fila
        $('#tabla-datos').on('click', '.eliminar', function () {
            $(this).closest('tr').remove();
            actualizarTotales();
        });

        // Actualizar totales
        function actualizarTotales() {
            let totalDebe = 0;
            let totalHaber = 0;

            $('#tabla-datos tr').each(function () {
                const debe = parseFloat($(this).find('.debe').text().replace(/,/g, "")) || 0;
                const haber = parseFloat($(this).find('.haber').text().replace(/,/g, "")) || 0;

                totalDebe += debe;
                totalHaber += haber;
            });

            $('#totalDebe').val(dollarUSLocale.format(totalDebe));
            $('#totalHaber').val(dollarUSLocale.format(totalHaber));
        }

        actualizarTotales();


        function obtenerDatosTabla() {
            const datos = [];

            $('#tabla-datos tr').each(function () {
                select = $(this).find('.codigo-select');
                codigo = select.val(); // Valor del select
                texto = select.find('option:selected').text(); // Texto visible del select

                if (texto.startsWith(codigo)) {
                    texto = texto.replace(codigo, '').trim(); // Elimina el código del inicio
                    texto = texto.startsWith('-') ? texto.substring(1).trim() : texto; // Elimina el guion si queda al inicio
                }

                sinopsis = $(this).find('.sinopsis').text().trim(); // Sinopsis
                debe = parseFloat($(this).find('.debe').text().replace(/,/g, "")) || 0; // Valor de DEBE
                haber = parseFloat($(this).find('.haber').text().replace(/,/g, "")) || 0; // Valor de HABER

                // Agregar datos al arreglo
                if (sinopsis != '') {
                    datos.push({
                        detalle_id: 0,
                        codigo: codigo,
                        texto: texto,
                        sinopsis: sinopsis,
                        debe: debe,
                        haber: haber
                    });
                }
            });

            return datos;
        }



        $('#btnGuardar').click(function (e) {
            e.preventDefault();

            tipo_partida = $('#tipo_partida').val().trim();
            sinopsisPartida = $('#sinopsisPartida').val().trim();
            tasa = $('#tasaCambio').val().trim();
            fecha_partida = $('#fechaPartida').val().trim();
            empresa = $('#empresaPartida').val().trim();

            debe = parseFloat($('#totalDebe').val().replace(/,/g, "")) || 0;
            haber = parseFloat($('#totalHaber').val().replace(/,/g, "")) || 0;

            balance = parseFloat($('#totalPartida').val().replace(/,/g, "")) || 0;

            // Validar que sean iguales
            if (debe !== haber) {
                Swal.fire("", "El Total DEBE y el Total HABER deben ser iguales.", "warning");
                return;
            }

            if (balance != debe || balance != haber) {
                Swal.fire("", "El Total de la Partida con el Total DEBE y el Total HABER deben ser iguales.", "warning");
                return;
            }

            // Continuar si es válido
            const arrDetalles = obtenerDatosTabla();

            $.ajax({
                url: "{% url 'insert_update_partidas_header_details' %}",
                type: 'POST',
                data: {
                    partida_id: partida_id,
                    tipo_partida: tipo_partida,
                    sinopsisPartida: sinopsisPartida,
                    empresa: empresa,
                    fecha_partida: fecha_partida,
                    balance: balance,
                    balanceD: 0,
                    tasa: tasa,
                    debe: debe,
                    haber: haber,
                    arrDetalles: JSON.stringify(arrDetalles),
                    opcion: opcion,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function (data) {
                    if (data.save == 1) {
                        if (opcion == 1) {
                            Swal.fire("", "Partida Guardada", "success");
                        } else {
                            Swal.fire("", "Partida Editada", "success");
                        }
                        window.location.reload();
                    } else {
                        Swal.fire("", "Error D: " + data.error, "error");
                    }
                }
            });




        });






        /*  */
    });
</script>
{% endblock %}